{% extends 'base.html' %}
{% load static %}

{% block title %}宏農·手工之家 - 每天現蒸，用心好味{% endblock %}
{% block content %}
<div class="bg-cream min-h-screen pb-10">
    <!-- 頂部導航 -->
    <nav class="bg-gradient-to-r from-primary to-primary-light text-white p-4 shadow-lg relative">
        <div class="container mx-auto flex justify-between items-center">
            <!-- 標誌和品牌名稱 -->
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.9A11.971 11.971 0 0112 20c-5.78 0-10.79-4.09-11.82-9.75C.19 9.55.05 8.53 0 7.5h5.25a4.5 4.5 0 018.25-2.96A4.5 4.5 0 0119 7.5h5c-.14 1.61-.49 3.16-1 4.5" />
                </svg>
                <h1 class="text-2xl font-bold">甜點小舖</h1>
            </div>
            
            <!-- 購物車圖標 -->
            <div class="relative" id="cart-icon">
                <div class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-all duration-300 cursor-pointer transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-secondary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shadow-md transform transition-transform duration-300 hover:scale-110">0</span>
            </div>
        </div>
        
        <!-- 裝飾曲線 -->
        <div class="absolute -bottom-3 left-0 right-0 h-4 overflow-hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 48" class="absolute bottom-0 w-full h-auto fill-current text-cream">
                <path d="M0,48L80,42.7C160,37,320,27,480,26.7C640,27,800,37,960,37.3C1120,37,1280,27,1360,21.3L1440,16L1440,48L1360,48C1280,48,1120,48,960,48C800,48,640,48,480,48C320,48,160,48,80,48L0,48Z"></path>
            </svg>
        </div>
    </nav>

    <!-- 歡迎訊息區塊 -->
    <div class="container mx-auto px-4 pt-10 pb-6">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-primary">今日手工甜點</h2>
            <p class="text-secondary-light mt-2">每一口都是幸福的滋味</p>
            <div class="w-24 h-1 bg-secondary mx-auto mt-3"></div>
        </div>
    </div>

    <!-- 產品類別選擇 - 精美樣式 -->
    <div class="container mx-auto px-4 mb-8">
        <div class="bg-cream-dark rounded-xl p-2 shadow-inner flex space-x-3 overflow-x-auto scrollbar-hide">
            <button class="category-btn whitespace-nowrap bg-primary text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-md" data-category="all">全部</button>
            {% for category in categories %}
                <button class="category-btn whitespace-nowrap bg-secondary text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-md" data-category="{{ category.name }}">{{ category.name }}</button>
            {% endfor %}
        </div>
    </div>

    <!-- 產品列表 -->
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products-container">
            {% for product in products %}
            <div class="product-card bg-paper rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-1 transform" data-id="{{ product.id }}" data-type="{{ product.product_type }}">
                <div class="relative">
                    <img src="{{ product.image }}" alt="{{ product.name }}" class="w-full h-48 object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
                    <div class="product-quantity absolute top-3 right-3 bg-primary text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold hidden shadow-lg border-2 border-white">0</div>
                </div>
                <div class="p-5">
                    <h3 class="text-xl font-bold text-primary truncate">{{ product.name }}</h3>
                    <div class="flex items-center mb-2">
                        <div class="flex text-yellow-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                            </svg>
                        </div>
                        <span class="text-xs text-gray-500 ml-1">(25)</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4 h-10 overflow-hidden">{{ product.description }}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-primary font-bold text-lg">NT${{ product.price }}</span>
                        <button class="add-to-cart bg-secondary hover:bg-secondary-light text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            加入購物車
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 購物車按鈕 - 懸浮設計 -->
        <div class="text-center mt-10">
            <button id="cart-open-btn" class="bg-primary hover:bg-primary-light text-white px-8 py-3 rounded-full inline-flex items-center transition-all duration-300 transform hover:scale-105 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="font-medium text-lg">查看購物車</span>
            </button>
        </div>
    </div>

    <!-- 購物車頁面 - 重新設計 -->
    <div id="cart-page" class="fixed inset-0 bg-cream flex flex-col z-50 hidden transition-opacity duration-300">
        <!-- 購物車頁面頂部導航 -->
        <nav class="bg-gradient-to-r from-primary to-primary-light text-white p-4 shadow-md relative">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    我的購物車
                </h1>
                <button id="close-cart-page" class="text-white bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- 裝飾曲線 -->
            <div class="absolute -bottom-3 left-0 right-0 h-4 overflow-hidden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 48" class="absolute bottom-0 w-full h-auto fill-current text-cream">
                    <path d="M0,48L80,42.7C160,37,320,27,480,26.7C640,27,800,37,960,37.3C1120,37,1280,27,1360,21.3L1440,16L1440,48L1360,48C1280,48,1120,48,960,48C800,48,640,48,480,48C320,48,160,48,80,48L0,48Z"></path>
                </svg>
            </div>
        </nav>
        
        <!-- 購物車內容區 -->
        <div class="container mx-auto px-4 py-8 flex-grow overflow-auto" id="cart-items-container">
            <!-- 空購物車訊息 -->
            <div id="empty-cart-message" class="text-center py-16 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <p class="text-xl">購物車是空的</p>
                <p class="mt-2 text-gray-400">快去選購喜愛的甜點吧！</p>
            </div>
            
            <!-- 購物車項目由JavaScript動態生成 -->
        </div>
        
        <!-- 訂單摘要和結帳按鈕 -->
        <div class="bg-white p-6 border-t border-gray-200 shadow-lg">
            <div class="container mx-auto">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <h3 class="font-bold text-primary text-xl">訂單摘要</h3>
                    <div class="flex justify-between text-primary w-full max-w-xs py-3">
                        <span class="text-lg">小計</span>
                        <span id="cart-subtotal" class="font-bold text-xl">NT$0</span>
                    </div>
                </div>

                <div class="w-full mb-4 h-0.5 bg-cream-dark"></div>
                
                <button id="checkout-btn-page" class="w-full bg-secondary hover:bg-secondary-light text-white py-3 rounded-lg font-medium text-lg transition-all duration-300 transform hover:scale-101 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    進行結帳
                </button>
            </div>
        </div>
    </div>

    <!-- 結帳彈窗 - 優化設計 -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-paper p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-primary">結帳資訊</h2>
                <button id="cancel-checkout" class="text-gray-400 hover:text-primary transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="checkout-form" class="space-y-5">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="name" name="name" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300">
                </div>
                
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">電話號碼</label>
                    <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300">
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="w-full bg-primary hover:bg-primary-light text-white py-3 rounded-lg font-medium text-lg transition-all duration-300">
                        確認訂單
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 初始化購物車
let cart = JSON.parse(localStorage.getItem('cart')) || [];
updateCartDisplay();

// 產品數據
const sampleProducts = [
    {% for product in products %}
    {
        id: {{ product.id }},
        name: "{{ product.name }}",
        price: {{ product.price }},
        description: "{{ product.description }}",
        image: "{{ product.image }}",
        type: "{{ product.product_type }}"
    },
    {% endfor %}
];

// 加入購物車
document.addEventListener('DOMContentLoaded', function() {
    // 加入購物車按鈕事件
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productCard = this.closest('.product-card');
            const productId = parseInt(productCard.dataset.id);
            
            const product = sampleProducts.find(p => p.id === productId)
            
            if (product) {
                // 檢查購物車中是否已有此產品
                const existingItemIndex = cart.findIndex(item => item.id === productId);
                
                if (existingItemIndex > -1) {
                    // 增加數量
                    cart[existingItemIndex].quantity += 1;
                } else {
                    // 添加新項目
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: 1,
                        type: product.type,
                        image: product.image
                    });
                }
                
                // 更新localStorage
                localStorage.setItem('cart', JSON.stringify(cart));
                
                // 更新UI
                updateCartDisplay();
                
                // 顯示添加到購物車的通知
                showNotification(`${product.name} 已加入購物車`);
            }
        });
    });


    const cartPage = document.getElementById('cart-page');
    // 購物車按鈕事件
    document.getElementById('cart-icon').addEventListener('click', openCartPage);
    document.getElementById('cart-open-btn').addEventListener('click', openCartPage);
    
    function openCartPage() {
        cartPage.classList.remove('hidden');
        renderCartPage();
    }

    // 關閉購物車頁面按鈕事件
    document.getElementById('close-cart-page').addEventListener('click', function() {
        cartPage.classList.add('hidden');
    });

    // 結帳按鈕事件
    document.getElementById('checkout-btn-page').addEventListener('click', function() {
        if (cart.length > 0) {
            document.getElementById('checkout-modal').classList.remove('hidden');
        } else {
            showNotification('購物車是空的，請先添加商品');
        }
    });

    // 取消結帳
    document.getElementById('cancel-checkout').addEventListener('click', function() {
        document.getElementById('checkout-modal').classList.add('hidden');
    });

    // 提交訂單
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const items = cart.map(item => ({
            id: item.id,
            name: item.name,
            quantity: item.quantity,
            price: item.price,
        }));
        
        // 提交訂單到後端（這裡只是示例）
        const orderData = {
            name: name,
            phone: phone,
            total_price: total,
            items: cart
        };
        
        fetch('/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(orderData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '提交訂單失敗');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('訂單提交成功:', data);
            // 清空購物車
            cart = [];
            localStorage.removeItem('cart');
            updateCartDisplay();
            
            // 關閉彈窗
            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('cart-page').classList.add('hidden');
            
            // 顯示成功消息
            showNotification(data.message || '訂單已成功提交！');
        })
        .catch(error => {
            console.error('訂單提交錯誤:', error);
            showNotification('訂單提交失敗：' + error.message);
        });
        
    });

    // 篩選產品類別
    document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // 更新按鈕樣式
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-primary');
                btn.classList.add('bg-secondary');
            });
            this.classList.remove('bg-secondary');
            this.classList.add('bg-primary');
            
            // 篩選產品
            document.querySelectorAll('.product-card').forEach(card => {
                const cardType = card.dataset.type;
                console.log(cardType,category);
                if (category === 'all' || cardType === category) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });


    // 監聽返回上一頁的動作
    const handleBackButton = function(event) {        
        // 檢查購物車是否開啟（假設有active或open類表示開啟狀態）
        if (cartPage && !cartPage.classList.contains('hidden')) {
        // 阻止默認的返回行為
        history.pushState(null, '', window.location.pathname);
        
        // 關閉購物車
        cartPage.classList.add('hidden');
        
        event.preventDefault();
        return false;
        }
    };

    // 監聽popstate事件（當用戶點擊返回按鈕時觸發）
    window.addEventListener('popstate', handleBackButton);
    
    // 在頁面加載時添加一個歷史狀態，這樣返回按鈕才能被捕獲
    history.pushState(null, '', window.location.pathname);
    
});

// 更新購物車顯示
function updateCartDisplay() {
    const cartCountElement = document.getElementById('cart-count');
    
    // 更新購物車計數
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCountElement.textContent = totalItems;
    
    // 更新產品卡片上的數量指示器
    document.querySelectorAll('.product-card').forEach(card => {
        const productId = parseInt(card.dataset.id);
        const quantityElement = card.querySelector('.product-quantity');
        const cartItem = cart.find(item => item.id === productId);
        
        if (cartItem && cartItem.quantity > 0) {
            quantityElement.textContent = cartItem.quantity;
            quantityElement.classList.remove('hidden');
        } else {
            quantityElement.classList.add('hidden');
        }
    });
}

// 渲染購物車頁面
function renderCartPage() {
    const cartItemsContainer = document.getElementById('cart-items-container');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const cartSubtotal = document.getElementById('cart-subtotal');
    
    // 清空容器
    cartItemsContainer.innerHTML = '';
    
    if (cart.length === 0) {
        cartItemsContainer.appendChild(emptyCartMessage);
    } else {
        // 隱藏空購物車消息
        if(emptyCartMessage) {
            emptyCartMessage.remove(); // 移除而不是隱藏，因為我們會重新創建新的購物車內容
        }
        
        // 遍歷購物車項目
        cart.forEach(item => {
            const cartItemElement = document.createElement('div');
            cartItemElement.className = 'bg-white mb-4 rounded-xl overflow-hidden max-w-3xl mx-auto shadow-md transform transition-all duration-300 hover:shadow-lg';
            cartItemElement.innerHTML = `
                <div class="flex flex-col md:flex-row overflow-hidden">
                    <div class="w-full md:w-1/4 p-4 flex justify-center items-center bg-cream-dark bg-opacity-20">
                        <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover rounded-lg shadow-md">
                    </div>
                    <div class="w-full md:w-3/4 p-4 md:pl-4">
                        <div class="flex justify-between items-start mb-3">
                            <h2 class="text-xl font-bold text-primary">${item.name}</h2>
                            <span class="text-primary font-bold">NT$${item.price}</span>
                        </div>
                        
                        <div class="flex flex-wrap justify-between items-center mt-4">
                            <div class="flex items-center space-x-1 bg-cream-dark bg-opacity-30 rounded-lg overflow-hidden">
                                <button class="cart-decrease text-primary w-10 h-10 flex items-center justify-center hover:bg-cream-dark transition-colors duration-300" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                </button>
                                <span class="w-10 h-10 flex items-center justify-center text-primary font-medium">${item.quantity}</span>
                                <button class="cart-increase text-primary w-10 h-10 flex items-center justify-center hover:bg-cream-dark transition-colors duration-300" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="flex items-center mt-3 md:mt-0">
                                <div class="text-primary font-medium mr-4">小計: <span class="font-bold">NT$${item.price * item.quantity}</span></div>
                                <button class="cart-remove flex items-center text-red-500 hover:text-red-700 transition-colors duration-300" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    移除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            cartItemsContainer.appendChild(cartItemElement);
        });
        
        // 計算總計
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartSubtotal.textContent = `NT$${total}`;
        
        // 添加購物車項目事件監聽器
        document.querySelectorAll('.cart-increase').forEach(button => {
            button.addEventListener('click', function() {
                increaseQuantity(parseInt(this.dataset.id));
                renderCartPage();
            });
        });
        
        document.querySelectorAll('.cart-decrease').forEach(button => {
            button.addEventListener('click', function() {
                decreaseQuantity(parseInt(this.dataset.id));
                renderCartPage();
            });
        });
        
        document.querySelectorAll('.cart-remove').forEach(button => {
            button.addEventListener('click', function() {
                removeItem(parseInt(this.dataset.id));
                renderCartPage();
            });
        });
    }
}

// 增加數量
function increaseQuantity(productId) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex > -1) {
        cart[itemIndex].quantity += 1;
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }
}

// 減少數量
function decreaseQuantity(productId) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex > -1) {
        if (cart[itemIndex].quantity > 1) {
            cart[itemIndex].quantity -= 1;
        } else {
            cart.splice(itemIndex, 1);
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }
}

// 移除項目
function removeItem(productId) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex > -1) {
        cart.splice(itemIndex, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
    }
}

// 通知功能
function showNotification(message) {
    // 創建通知元素
    const notification = document.createElement('div');
    notification.className = 'fixed bottom-4 right-4 bg-primary text-white px-5 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-0 z-50 flex items-center';
    
    notification.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        ${message}
    `;
    
    // 添加到頁面
    document.body.appendChild(notification);
    
    // 3秒後淡出
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}
</script>
{% endblock %}